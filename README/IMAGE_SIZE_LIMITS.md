# DeepSeek-OCR 影像尺寸限制說明

## 概述

DeepSeek-OCR 能夠處理各種尺寸的影像，但有一些限制和處理機制。本文檔詳細說明影像尺寸的相關限制和處理方式。

## 檔案大小限制

### 上傳檔案大小限制

- **最大檔案大小**：**16 MB**
- **配置位置**：`config.py` 和 `app.py`
- **設定值**：`MAX_CONTENT_LENGTH = 16 * 1024 * 1024`

### 如何修改檔案大小限制

如果需要處理更大的檔案，可以修改配置：

**方法 1：修改 `config.py`**
```python
class Config:
    MAX_CONTENT_LENGTH = 32 * 1024 * 1024  # 改為 32MB
```

**方法 2：修改 `app.py`**
```python
app.config['MAX_CONTENT_LENGTH'] = 32 * 1024 * 1024  # 改為 32MB
```

**注意事項**：
- 增加檔案大小限制會增加記憶體使用
- 建議根據伺服器資源調整
- 過大的檔案可能導致處理時間過長或記憶體不足

---

## 影像像素尺寸處理

### 處理機制

DeepSeek-OCR 使用動態預處理機制來處理不同尺寸的影像：

#### 1. 小尺寸影像（≤ 640x640）

- **直接處理**：如果影像的寬度和高度都 ≤ 640 像素，會直接處理，不進行分割
- **處理方式**：整個影像作為一個區塊處理

#### 2. 大尺寸影像（> 640x640）

- **動態分割**：使用 `dynamic_preprocess` 函數將影像分割成多個 640x640 的區塊
- **全域視圖**：同時生成一個全域視圖（預設 1024x1024）用於整體理解
- **自動調整**：根據影像的寬高比，自動選擇最適合的分割方式

### 處理參數

#### base_size（全域視圖尺寸）

- **預設值**：**1024** 像素
- **用途**：生成全域視圖的尺寸
- **支援的值**：
  - `1024`：256 tokens（預設）
  - `1280`：400 tokens
  - `640`：100 tokens（註解掉的選項）

#### image_size（分割區塊尺寸）

- **預設值**：**640** 像素
- **用途**：將大影像分割成多個 640x640 的區塊進行處理
- **固定值**：目前固定為 640，不建議修改

### 程式碼位置

**配置位置**：`ocr_service.py` 第 285-286 行
```python
base_size=1024,    # 全域視圖尺寸
image_size=640,     # 分割區塊尺寸
```

**處理邏輯**：`deepseek_ocr/modeling_deepseekocr.py`
- 第 176-214 行：`dynamic_preprocess` 函數
- 第 712-810 行：`infer` 函數中的影像處理邏輯

---

## 實際處理範例

### 範例 1：小影像（500x300）

```
原始尺寸：500 x 300
處理方式：直接處理，不分割
全域視圖：調整為 1024x1024（保持寬高比，填充黑邊）
```

### 範例 2：中等影像（1920x1080）

```
原始尺寸：1920 x 1080
處理方式：分割成多個 640x640 區塊
分割數量：約 6 個區塊（2x3）
全域視圖：調整為 1024x1024
```

### 範例 3：大影像（4000x3000）

```
原始尺寸：4000 x 3000
處理方式：分割成多個 640x640 區塊
分割數量：約 30 個區塊（5x6）
全域視圖：調整為 1024x1024
```

---

## 理論最大尺寸

### 像素尺寸限制

- **理論上無固定限制**：DeepSeek-OCR 可以處理任意像素尺寸的影像
- **實際限制**：
  1. **檔案大小**：16 MB（可調整）
  2. **記憶體限制**：取決於 GPU/CPU 記憶體
  3. **處理時間**：大影像需要更多處理時間

### 建議的影像尺寸

為了獲得最佳效能和品質，建議：

1. **一般使用**：
   - 長邊不超過 **2048 像素**
   - 檔案大小控制在 **5-10 MB** 以內

2. **高品質需求**：
   - 長邊不超過 **4096 像素**
   - 檔案大小控制在 **10-16 MB** 以內

3. **批次處理**：
   - 建議每張影像長邊不超過 **1024 像素**
   - 以加快處理速度

---

## 前端預處理選項

在 `example_bookReader` 中，提供了「送交模型的長邊尺寸」選項：

- **選項**：320, 480, 640, 960, 1024, 2048
- **預設值**：1024
- **功能**：在上傳前調整影像尺寸，減少檔案大小和處理時間

### 使用建議

- **快速處理**：選擇 640 或 960
- **平衡品質與速度**：選擇 1024（預設）
- **高品質需求**：選擇 2048

---

## 效能考量

### 處理時間

| 影像尺寸 | 處理時間（約） |
|---------|--------------|
| ≤ 640x640 | 1-3 秒 |
| 1024x1024 | 2-5 秒 |
| 1920x1080 | 5-10 秒 |
| 4000x3000 | 15-30 秒 |

*實際處理時間取決於影像內容複雜度和 GPU 效能*

### 記憶體使用

- **小影像（≤ 640x640）**：約 2-4 GB GPU 記憶體
- **中等影像（1024x1024）**：約 4-6 GB GPU 記憶體
- **大影像（> 2048x2048）**：約 6-12 GB GPU 記憶體

*建議至少 8 GB GPU 記憶體*

---

## 常見問題

### Q1: 可以處理超過 16MB 的檔案嗎？

**A**: 可以，但需要修改配置檔案中的 `MAX_CONTENT_LENGTH` 設定。不過要注意：
- 大檔案會增加處理時間
- 需要更多 GPU 記憶體
- 可能導致超時錯誤

### Q2: 影像會被裁切嗎？

**A**: 不會。DeepSeek-OCR 使用 `ImageOps.pad` 來處理影像，會保持原始寬高比，不足的部分會填充黑邊。

### Q3: 如何加快處理速度？

**A**: 
1. 在上傳前調整影像尺寸（使用前端選項）
2. 選擇較小的「送交模型的長邊尺寸」
3. 確保使用 GPU 加速
4. 對於批次處理，使用批次 API

### Q4: 為什麼我的大影像處理很慢？

**A**: 大影像會被分割成多個區塊，每個區塊都需要處理時間。建議：
- 在上傳前調整影像尺寸
- 選擇適當的「送交模型的長邊尺寸」
- 確保有足夠的 GPU 記憶體

---

## 相關檔案

- `config.py`：配置檔案大小限制
- `app.py`：Flask 應用配置
- `ocr_service.py`：OCR 服務實作
- `deepseek_ocr/modeling_deepseekocr.py`：模型處理邏輯
- `example_bookReader/static/js/book_reader.js`：前端影像預處理

---

## 更新記錄

- **2025-01-12**：初始版本，記錄影像尺寸限制和處理機制

